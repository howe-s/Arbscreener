{% extends "base.html" %}

{% block title %}Home - Dexscreener{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Summary Div -->
    <div class="interactive-chart-container">
        
        <div class="d-none d-md-block" id="summary-div">        
          {{ chart_div | safe }}
            <!-- Summary content will be dynamically inserted here -->
        </div>
    </div>

    <!-- Card Container -->
    <div class="row">
        {% for data in pool_data %}
        <div class="col-md-6 mb-6">
          <div class="card" data-token-pair="{{ data['pool_address'] }}">
            <div class="card-body">
              <h5 class="card-title">{{ data['base_token'] }} / {{ data['quote_token'] }}</h5>
              <p><strong>Chain ID:</strong>{{ data['chain_id'] }}</p>
              <table class="table table-striped">
                <tbody>
                  <tr>
                    <th>USD</th>
                    <th>base</th>
                    <th>quote</th>
                  </tr>
                  <tr>
                    <td><strong></strong>{{ data['liquidity_usd_formatted']}}</p></td>
                    <td><strong>{{ data['base_token'] }}:</strong> {{ data['liquidity_base_formatted']}}</p></td>
                    <td><strong>{{ data['quote_token'] }}:</strong> {{ data['liquidity_quote_formatted']}}</p></td>
                  </tr>
                </tbody>
              </table>
              <p><strong>Price (Native):</strong>{{ data['price_native'] | round(2) }}</p>
              <p><strong>Price (USD):</strong>{{ data['price_usd_formatted'] }}</p>
              <table class="table table-striped">
                <tbody>
                  <tr>
                    <th>USD</th>
                    <th>base</th>
                    <th>quote</th>
                  </tr>
                  <tr>
                    <td><strong>Volume (5m):</strong>{{ data['volume_5m_formatted'] }}</p></td>
                    <td><strong>Volume (1h):</strong>{{ data['volume_1h_formatted'] }}</p></td>
                    <td><strong>Volume (6h):</strong>{{ data['volume_6h_formatted'] }}</p></td>
                    <td><strong>Volume (24h):</strong>{{ data['volume_24h_formatted'] }}</td>
                  </tr>
                </tbody>
              </table>
              <p><strong>Volume (5m):</strong>{{ data['volume_5m_formatted'] }}</p>
              <p><strong>Volume (1h):</strong>{{ data['volume_1h_formatted'] }}</p>
              <p><strong>Volume (6h):</strong>{{ data['volume_6h_formatted'] }}</p>
              <p><strong>Volume (24h):</strong>{{ data['volume_24h_formatted'] }}</p>
              <p><strong>Pair Address:</strong>{{ data['pool_address'] }}</p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.card');
    const summaryDiv = document.getElementById('summary-div');   

    cards.forEach(card => {
        card.addEventListener('click', () => {
            const tokenPairAddress = card.getAttribute('data-token-pair');
            console.log(tokenPairAddress);

            sendTokenPairAddressToFlask(tokenPairAddress);

            summaryDiv.style.display = 'block';
        });
    });

    function sendTokenPairAddressToFlask(tokenPairAddress) {
        fetch('/process-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tokenPairAddress: tokenPairAddress }),
        })
        .then(response => response.json())
        .then(data => {
        console.log('Success:', data.pair_URL);
        const pair_URL = data.pair_URL;
        const chain_id = data.chain_id;
        const dex_id = data.dex_id;
        const quote_token = data.quote_token;
        const base_token = data.base_token;
        const chart_div = data.chart_div;
        const x_data = data.x_data;
        const y_data = data.y_data;

        summaryDiv.innerHTML = `
            <div> 
                <p>${base_token} / ${quote_token}</p> 
                <p>Chain: ${chain_id}</p> 
                <p>Dex: ${dex_id}</p>
                <p>URL: <a href="${pair_URL}">${pair_URL}</a></p>
                <div id="chart"></div>
            </div>
        `;
            // Generate the chart directly on the client side
        const trace = {
            x: x_data,
            y: y_data,
            type: 'bar'
        };
        
        const layout = {
            title: base_token + '/' + quote_token,
            xaxis: { title: 'Time Frame' },
            yaxis: { title: 'Volume' }
        };
        
        Plotly.newPlot('chart', [trace], layout);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
});

</script>
{% endblock %}
