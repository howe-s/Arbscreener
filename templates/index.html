{% extends "base.html" %}

{% block title %}Home - Dexscreener{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Summary Div -->
    <div class="d-none d-md-block" id="summary-div">
        <!-- Summary content will be dynamically inserted here -->
    </div>

    <!-- Card Container -->
    <div class="row">
        {% for data in pool_data %}
        <div class="col-md-4 mb-4">
            <div class="card" data-token-pair="{{ data['pool_address'] }}">
                <div class="card-body">
                    <h5 class="card-title">{{ data['quote_token'] }} / {{ data['base_token'] }}</h5>
                    <p><strong>Chain ID:</strong> {{ data['chain_id'] }}</p>
                    <p><strong>Liquidity (USD):</strong> ${{ data['liquidity'].usd | round(0) }}</p>
                    <p><strong>Price (Native):</strong> {{ data['price_native'] | round(2) }}</p>
                    <p><strong>Price (USD):</strong> {{ data['price_usd_formatted'] }}</p>
                    <p><strong>Volume (24h):</strong> {{ data['volume_24h_formatted'] }}</p>
                    <p><strong>Pair Address:</strong> {{ data['pool_address'] }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.card');
    const summaryDiv = document.getElementById('summary-div');   
    cards.forEach(card => {
        card.addEventListener('click', () => {
            const tokenPairAddress = card.querySelector('[data-token-pair]').getAttribute('data-token-pair');
            const cardTitle = card.querySelector('.card-title').textContent;
            const cardVolume = card.querySelector('[data-volume]').textContent;
            const cardPriceNative = card.querySelector('[data-price-native]').textContent;
            const cardPriceUSD = card.querySelector('[data-price-usd]').textContent;
            const cardLiquidity = card.querySelector('[data-liquidity]').textContent;           
            console.log(tokenPairAddress);

            sendTokenPairAddressToFlask(tokenPairAddress, cardTitle);

            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = `
                <div> 
                    <p> ${cardTitle} </p> 
                    <p> Chain: ${data.chain_id} </p> 
                    <p> Dex: ${data.dex_id} </p>
                    <p> URL: <a href="${data.pair_URL}">${data.pair_URL}</a> </p>
                    <img src="transaction_chart.png?t=${new Date().getTime()}" alt="Transaction Chart">
                </div>
            `;
        });
    });

    function sendTokenPairAddressToFlask(tokenPairAddress, cardTitle) {
        fetch('/process-data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ tokenPairAddress: tokenPairAddress, cardTitle: cardTitle }),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Success this one:', data.pair_URL);
            const pair_URL = data.pair_URL;
            const chain_id = data.chain_id;
            const dex_id = data.dex_id;
            const quote_token = data.quote_token;
            const base_token = data.base_token;
            
            summaryDiv.innerHTML = `
                <div> 
                    <p> ${quote_token} / ${base_token} </p> 
                    <p> Chain: ${chain_id} </p> 
                    <p> Dex: ${dex_id} </p>
                    <p> URL: <a href="${pair_URL}">${pair_URL}</a> </p>
                    <img src="transaction_chart.png?t=${new Date().getTime()}" alt="Transaction Chart">
                </div>
            `;
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
});
</script>
{% endblock %}
