{% extends "base.html" %}

{% block title %}Arb - Dexscreener{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/userProfile.css') }}">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Function to fetch arbitrage data
            function fetchArbitrageData() {
                $.ajax({
                    type: 'POST',
                    url: '/get_arbitrage_data',
                    success: function(data) {
                        let arbitrageContainer = $('#arbitrage-opportunities');
                        arbitrageContainer.empty();  // Clear previous content

                        if (data.length > 0) {
                            data.forEach(opportunity => {
                                // Create card for each opportunity
                                let cardHTML = `
                                    <div class="col">
                                        <div class="card shadow-sm h-100">
                                            <div class="card-header text-left">
                                                <h5 class="card-title mb-0">Arbitrage Opportunity</h5>
                                            </div>
                                            <div class="card-body p-3">
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Detail</th>
                    <th>${opportunity.pair1}</th>
                    <th>${opportunity.pair2}</th>
                    ${opportunity.pair3 ? `<th>${opportunity.pair3}</th>` : ''}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>Price</th>
                    <td>US $ ${opportunity.pair1_price_round}</td>
                    <td>US $ ${opportunity.pair2_price_round}</td>
                    ${opportunity.pair3 ? `<td>US $ ${opportunity.pair3_price_round}</td>` : ''}
                </tr>
                <tr>
                    <th>Price Native</th>
                    <td>${opportunity.pair1_priceNative_round}</td>
                    <td>${opportunity.pair2_priceNative_round}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_priceNative_round}</td>` : ''}
                </tr>
                <tr>
                    <th>Liquidity</th>
                    <td>${opportunity.pair1_liquidity}</td>
                    <td>${opportunity.pair2_liquidity}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_liquidity}</td>` : ''}
                </tr>
                <tr>
                    <th>Base Liquidity</th>
                    <td>${opportunity.pair1_liquidity_base}</td>
                    <td>${opportunity.pair2_liquidity_base}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_liquidity_base}</td>` : ''}
                </tr>
                <tr>
                    <th>Quote Liquidity</th>
                    <td>${opportunity.pair1_liquidity_quote}</td>
                    <td>${opportunity.pair2_liquidity_quote}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_liquidity_quote}</td>` : ''}
                </tr>
                <tr>
                    <th>Chain ID</th>
                    <td>${opportunity.pair1_chain_id}</td>
                    <td>${opportunity.pair2_chain_id}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_chain_id}</td>` : ''}
                </tr>
                <tr>
                    <th>Dex ID</th>
                    <td>${opportunity.pair1_dex_id}</td>
                    <td>${opportunity.pair2_dex_id}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_dex_id}</td>` : ''}
                </tr>
                <tr>
                    <th>Base Token Address</th>
                    <td>${opportunity.pair1_baseToken_address}</td>
                    <td>${opportunity.pair2_baseToken_address}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_baseToken_address}</td>` : ''}
                </tr>
                <tr>
                    <th>Quote Token Address</th>
                    <td>${opportunity.pair1_quoteToken_address}</td>
                    <td>${opportunity.pair2_quoteToken_address}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pair3_quoteToken_address}</td>` : ''}
                </tr>
                <tr>
                    <th>Address</th>
                    <td>${opportunity.pool_pair1_address}</td>
                    <td>${opportunity.pool_pair2_address}</td>
                    ${opportunity.pair3 ? `<td>${opportunity.pool_pair3_address}</td>` : ''}
                </tr>
                <tr>
                    <th>URL</th>
                    <td>
                        <a href="${opportunity.pool_pair1_url}" target="_blank" class="card-link" title="${opportunity.pool_pair1_url}">
                            ${opportunity.pool_pair1_url.substring(0, 30)}...
                        </a>
                    </td>
                    <td>
                        <a href="${opportunity.pool_pair2_url}" target="_blank" class="card-link" title="${opportunity.pool_pair2_url}">
                            ${opportunity.pool_pair2_url.substring(0, 30)}...
                        </a>
                    </td>
                    ${opportunity.pair3 ? 
                        `<td>
                            <a href="${opportunity.pool_pair3_url}" target="_blank" class="card-link" title="${opportunity.pool_pair3_url}">
                                ${opportunity.pool_pair3_url.substring(0, 30)}...
                            </a>
                        </td>` : ''}
                </tr>
            </tbody>
        </table>
    </div>
</div>
                                        </div>
                                    </div>`;
                                arbitrageContainer.append(cardHTML);
                            });
                        } else {
                            arbitrageContainer.append('<p>No arbitrage opportunities found.</p>');
                        }
                        
                        // Equalize card widths after adding new content
                        let cards = document.querySelectorAll('.card.shadow-sm');
                        let maxWidth = 0;
                        cards.forEach(card => {
                            maxWidth = Math.max(maxWidth, card.offsetWidth);
                        });
                        cards.forEach(card => {
                            card.style.minWidth = maxWidth + 'px';
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching arbitrage data:', error);
                    }
                });
            }

            fetchArbitrageData();  // Call this function when the document is ready
        });
    </script>

    <div class="container-fluid" id="user-purchases">
        <h1 class="mb-4">Welcome, {{ name }}!</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div id="add_contract" class="card mb-4">
                    <div class="card-header">
                        <h2>Add Contract</h2>
                    </div>
                    <div class="card-body">
                        <form method="post" action="/add_purchase">
                            <div class="mb-3">
                                <label for="asset_name" class="form-label">Asset Name:</label>
                                <input type="text" name="asset_name" id="asset_name" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="baseToken_address" class="form-label">Token Address:</label>
                                <input name="baseToken_address" id="baseToken_address" class="form-control" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Add Purchase</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2>Tracked Contracts</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="my-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Asset</th>
                                        <th scope="col" style="word-wrap: break-word; max-width: 200px;">Asset Address</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if current_user.purchases %}
                                        {% for purchase in current_user.purchases %}
                                        <tr class="purchase-row" data-purchase-id="{{ purchase.id }}">
                                            <td>{{ purchase.asset_name }}</td>
                                            <td id="baseToken-address">
                                                <a href="{{ purchase.baseToken_url }}">{{ purchase.baseToken_address }}</a>
                                            </td>
                                            <td>
                                                <form method="post" action="{{ url_for('delete_purchase', purchase_id=purchase.id) }}" style="display:inline;">
                                                    <button type="submit" class="btn btn-danger btn-sm">X</button>
                                                </form>
                                                <a href="{{ url_for('edit_purchase', purchase_id=purchase.id) }}" class="btn btn-info btn-sm">Edit</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="3" class="text-center">No contracts currently tracked.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="arbitrage-opportunities" class="row row-cols-1 row-cols-md-3 g-3">
            <!-- Arbitrage opportunities will be populated here by JavaScript -->
        </div>
    </div>
</html>
{% endblock %}