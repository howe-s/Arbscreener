{% extends "base.html" %}

{% block title %}Arb - Dexscreener{% endblock %}

{% block content %}    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/userProfile.css') }}">
    <script>  
      document.addEventListener('DOMContentLoaded', () => {
      
      document.querySelectorAll('.purchase-row').forEach(row => {
          fetchPrice(row.dataset.purchaseId);
      });
      window.addEventListener("load", function() {
      let cards = document.querySelectorAll('.card.mb-4'); // Corrected class selection
      let maxWidth = 0;

      // Find the maximum width of all cards
      cards.forEach(function(card) {
          maxWidth = Math.max(maxWidth, card.offsetWidth);
      });

      // Set all cards to have the width of the largest card
      cards.forEach(function(card) {
          card.style.minWidth = maxWidth + 'px';
      });
  });
  });
  </script>
    <div class="container-fluid" id="user-purchases">
        <h1 class="mb-4">Welcome, {{ name }}!</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div id="add_contract" class="card mb-4">
                    <div class="card-header">
                        <h2>Add Contract</h2>
                    </div>
                    <div class="card-body">
                        <form method="post" action="/add_purchase">
                            <div class="mb-3">
                                <label for="asset_name" class="form-label">Asset Name:</label>
                                <input type="text" name="asset_name" id="asset_name" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label for="baseToken_address" class="form-label">Token Address:</label>
                                <input name="baseToken_address" id="baseToken_address" class="form-control" required>
                            </div>                            
                            <button type="submit" class="btn btn-primary">Add Purchase</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h2>Tracked Contracts</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered" id="my-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Asset</th>
                                        <th scope="col" style="table-layout: fixed">Asset Address</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                  {% if current_user.purchases %}
                                      {% for purchase in current_user.purchases %}
                                      <tr class="purchase-row" data-purchase-id="{{ purchase.id }}">
                                          <td class="table-td">{{ purchase.asset_name }}</td>
                                          <td id="baseToken-address" class="table-td">
                                              <a id="baseToken-link" href="{{ purchase.baseToken_url }}">{{ purchase.baseToken_address }}</a>
                                          </td>
                                          <td>
                                              <form method="post" action="{{ url_for('delete_purchase', purchase_id=purchase.id) }}" style="display:inline;">
                                                  <button type="submit" class="btn btn-danger btn-sm">X</button>
                                              </form>
                                              <a href="{{ url_for('edit_purchase', purchase_id=purchase.id) }}" class="btn btn-info btn-sm">Edit</a>
                                          </td>
                                      </tr>
                                      {% endfor %}
                                  {% else %}
                                      <tr>
                                          <td colspan="3" class="text-center">No contracts currently tracked.</td>
                                      </tr>
                                  {% endif %}
                              </tbody>                              
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-3 g-3"> <!-- Using Bootstrap's grid system for responsive layout -->
          {% for opportunity in arbitrage_opportunities %}
          <div class="col">
            <div class="card shadow-sm h-100">
              <div class="card-header text-left">
                <h5 class="card-title mb-0">Arbitrage Opportunity</h5>
              </div>
              <div class="card-body p-3">
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th scope="col" style="width: 20%;">Detail</th>
                        <th scope="col" style="width: 20%;">{{ opportunity.pair1 }}</th>
                        <th scope="col" style="width: 20%;">{{ opportunity.pair2 }}</th>
                        {% if 'pair3' in opportunity %}
                        <th scope="col" style="width: 40%;">{{ opportunity.pair3 }}</th>
                        {% endif %}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <th scope="row">Price</th>
                        <td>US $ {{ opportunity.pair1_price_round }}</td>
                        <td>US $ {{ opportunity.pair2_price_round }}</td>
                        {% if 'pair3' in opportunity %}
                        <td>US $ {{ opportunity.pair3_price_round }}</td>
                        {% endif %}
                    </tr>
                      <tr>
                        <th scope="row">Price Native</th>
                        <td>{{ opportunity.pair1_priceNative_round }}</td>
                        <td>{{ opportunity.pair2_priceNative_round }}</td>
                        {% if 'pair3' in opportunity %}
                        <td>{{ opportunity.pair3_priceNative_round }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Liquidity</th>
                        <td>{{ opportunity.pair1_liquidity }}</td>
                        <td>{{ opportunity.pair2_liquidity }}</td>
                        {% if 'pair3' in opportunity %}
                        <td>{{ opportunity.pair3_liquidity }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Base Liquidity</th>
                        <td>{{ opportunity.pair1_liquidity_base }}</td>
                        <td>{{ opportunity.pair2_liquidity_base }}</td>
                        {% if 'pair3' in opportunity %}
                        <td>{{ opportunity.pair3_liquidity_base }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Quote Liquidity</th>
                        <td>{{ opportunity.pair1_liquidity_quote }}</td>
                        <td>{{ opportunity.pair2_liquidity_quote }}</td>
                        {% if 'pair3' in opportunity %}
                        <td>{{ opportunity.pair3_liquidity_quote }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Chain ID</th>
                        <td>{{ opportunity.pair1_chain_id }}</td>
                        <td>{{ opportunity.pair2_chain_id }}</td>
                        {% if 'pair3' in opportunity %}
                        <td>{{ opportunity.pair3_chain_id }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Dex ID</th>
                        <td>{{ opportunity.pair1_dex_id }}</td>
                        <td>{{ opportunity.pair2_dex_id }}</td>
                        {% if 'pair3' in opportunity %}
                        <td>{{ opportunity.pair3_dex_id }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Base Token Address</th>
                        <td class="table-td">{{ opportunity.pair1_baseToken_address }}</td>
                        <td class="table-td">{{ opportunity.pair2_baseToken_address }}</td>
                        {% if 'pair3' in opportunity %}
                        <td class="table-td">{{ opportunity.pair3_baseToken_address }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Quote Token Address</th>
                        <td class="table-td">{{ opportunity.pair1_quoteToken_address }}</td>
                        <td class="table-td">{{ opportunity.pair2_quoteToken_address }}</td>
                        {% if 'pair3' in opportunity %}
                        <td class="table-td">{{ opportunity.pair3_quoteToken_address }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">Address</th>
                        <td class="table-td">{{ opportunity.pool_pair1_address }}</td>
                        <td class="table-td">{{ opportunity.pool_pair2_address }}</td>
                        {% if 'pair3' in opportunity %}
                        <td class="table-td">{{ opportunity.pool_pair3_address }}</td>
                        {% endif %}
                      </tr>
                      <tr>
                        <th scope="row">URL</th>
                        <td>
                          <a href="{{ opportunity.pool_pair1_url }}" target="_blank" class="card-link" title="{{ opportunity.pool_pair1_url }}">
                            {{ opportunity.pool_pair1_url | truncate(30, True) }}
                          </a>
                        </td>
                        <td>
                          <a href="{{ opportunity.pool_pair2_url }}" target="_blank" class="card-link" title="{{ opportunity.pool_pair2_url }}">
                            {{ opportunity.pool_pair2_url | truncate(30, True) }}
                          </a>
                        </td>
                        {% if 'pair3' in opportunity %}
                        <td>
                          <a href="{{ opportunity.pool_pair3_url }}" target="_blank" class="card-link" title="{{ opportunity.pool_pair3_url }}">
                            {{ opportunity.pool_pair3_url | truncate(30, True) }}
                          </a>
                        </td>
                        {% endif %}
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        
    </div>
</html>
{% endblock %}